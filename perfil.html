<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Swift Hub Catalão - Perfil do Usuário">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swift Hub Catalão - Meu Perfil</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            signInWithPhoneNumber,
            RecaptchaVerifier
        } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

        // Configure seu Firebase (substitua pelos seus dados)
        const firebaseConfig = {
            apiKey: "AIzaSyDGBKxvfcY-PA_vC7SA8G0f-TjqjK3OD3o",
            authDomain: "swifthubcatalao.firebaseapp.com",
            projectId: "swifthubcatalao",
            storageBucket: "swifthubcatalao.firebasestorage.app",
            messagingSenderId: "756803145076",
            appId: "1:756803145076:web:097f4d3d5b28cc6ca1f021"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // Initialize Firestore

        let confirmationResult = null; // Store confirmation result from phone auth
        let recaptchaVerifier = null;   // Store the reCAPTCHA verifier

        // --- Inactivity Logout Logic ---
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes
        let logoutTimer = null;

        function resetTimer() {
          if (logoutTimer) clearTimeout(logoutTimer);
          logoutTimer = setTimeout(() => {
            console.log("Inatividade detectada. Desconectando...");
            signOut(auth).then(() => {
              alert("Você foi desconectado por inatividade.");
              window.location.replace("login.html");
            }).catch(error => {
              console.error("Erro ao desconectar por inatividade:", error);
              window.location.replace("login.html");
            });
          }, INACTIVITY_TIMEOUT);
        }

        function setupInactivityListeners() {
            document.removeEventListener("mousemove", resetTimer);
            document.removeEventListener("keydown", resetTimer);
            document.removeEventListener("click", resetTimer);
            document.removeEventListener("scroll", resetTimer);
            document.addEventListener("mousemove", resetTimer);
            document.addEventListener("keydown", resetTimer);
            document.addEventListener("click", resetTimer);
            document.addEventListener("scroll", resetTimer);
            console.log("Listeners de inatividade configurados.");
            resetTimer();
        }

        function removeInactivityListeners() {
            if (logoutTimer) clearTimeout(logoutTimer);
            document.removeEventListener("mousemove", resetTimer);
            document.removeEventListener("keydown", resetTimer);
            document.removeEventListener("click", resetTimer);
            document.removeEventListener("scroll", resetTimer);
            console.log("Listeners de inatividade removidos.");
        }
        // --- End Inactivity Logout Logic ---

        // Check authentication state
        onAuthStateChanged(auth, user => {
            const logoutBtn = document.getElementById("logoutButton");
            if (user) {
                console.log("Usuário logado:", user.uid);
                if (logoutBtn) logoutBtn.style.display = "block";
                displayUserProfile(user);
                setupInactivityListeners();
                initializeRecaptcha(user);
            } else {
                console.log("Nenhum usuário logado, redirecionando para login.");
                if (logoutBtn) logoutBtn.style.display = "none";
                removeInactivityListeners();
                window.location.replace("login.html");
            }
        });

        // Load user profile data from Firestore
        async function displayUserProfile(user) {
            const emailElement = document.getElementById("userEmail");
            const nameInput = document.getElementById("userName");
            const addressInput = document.getElementById("userAddress");
            const phoneInput = document.getElementById("userPhone");
            const phoneStatus = document.getElementById("phoneVerificationStatus");
            const verifyCodeSection = document.getElementById("verifyCodeSection");
            const sendCodeSection = document.getElementById("sendCodeSection");
            const phoneStatusMessage = document.getElementById("phoneStatusMessage");

            // Display email
            emailElement.innerText = user.email || "Email não disponível";

            // Check if phone number is already verified
            if (user.phoneNumber) {
                phoneInput.value = user.phoneNumber;
                phoneInput.disabled = true;
                document.getElementById("sendCodeButton").style.display = "none";
                phoneStatus.innerText = "Telefone verificado: " + user.phoneNumber;
                phoneStatus.style.color = "green";
                sendCodeSection.style.display = "none";
                verifyCodeSection.style.display = "none";
                document.getElementById("recaptcha-container").style.display = "none";
            } else {
                phoneStatus.innerText = "Telefone não verificado.";
                phoneStatus.style.color = "orange";
                sendCodeSection.style.display = "block";
                verifyCodeSection.style.display = "none";
                document.getElementById("recaptcha-container").style.display = "block";
            }

            // Fetch name and address from Firestore
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                nameInput.value = userData.name || "";
                addressInput.value = userData.address || "";
                if (userData.phoneNumber && !user.phoneNumber) {
                    phoneInput.value = userData.phoneNumber;
                    phoneInput.disabled = true;
                    document.getElementById("sendCodeButton").style.display = "none";
                    phoneStatus.innerText = "Telefone (via dados salvos): " + userData.phoneNumber;
                    phoneStatus.style.color = "blue";
                    sendCodeSection.style.display = "none";
                    verifyCodeSection.style.display = "none";
                    document.getElementById("recaptcha-container").style.display = "none";
                }
            } else {
                console.log("Nenhum dado de perfil encontrado para este usuário.");
            }
        }

        // Initialize reCAPTCHA Verifier
        function initializeRecaptcha(user) {
            if (!user || user.phoneNumber) {
                console.log("reCAPTCHA não inicializado: usuário não logado ou telefone já verificado.");
                document.getElementById("recaptcha-container").style.display = "none";
                return;
            }

            if (!recaptchaVerifier) {
                recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {
                    'size': 'normal',
                    'callback': (response) => {
                        console.log("reCAPTCHA resolvido!");
                        document.getElementById("sendCodeButton").disabled = false;
                    },
                    'expired-callback': () => {
                        console.log("reCAPTCHA expirado. Resolva novamente.");
                        document.getElementById("sendCodeButton").disabled = true;
                        recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                    }
                }, auth);

                recaptchaVerifier.render().then(widgetId => {
                    console.log("reCAPTCHA renderizado. Widget ID:", widgetId);
                    document.getElementById("sendCodeButton").disabled = true;
                });
            } else {
                console.log("reCAPTCHA já inicializado.");
                recaptchaVerifier.render().then(widgetId => {
                    document.getElementById("recaptcha-container").style.display = "block";
                    grecaptcha.reset(widgetId);
                    document.getElementById("sendCodeButton").disabled = true;
                });
            }
        }

        // Handle sending the SMS verification code
        async function handleSendCode(event) {
            event.preventDefault();

            const phoneInput = document.getElementById("userPhone");
            const phoneStatusMessage = document.getElementById("phoneStatusMessage");
            const sendCodeButton = document.getElementById("sendCodeButton");
            const verifyCodeSection = document.getElementById("verifyCodeSection");
            const sendCodeSection = document.getElementById("sendCodeSection");

            // Processa o número: se não começa com "+", adiciona o código brasileiro (+55)
            let phoneNumber = phoneInput.value.trim();
            if (!phoneNumber.startsWith("+")) {
                phoneNumber = "+55" + phoneNumber;
            }

            if (phoneNumber.length < 10) {
                phoneStatusMessage.innerText = "Formato de telefone inválido.";
                phoneStatusMessage.style.color = "red";
                return;
            }

            sendCodeButton.disabled = true;
            phoneStatusMessage.innerText = "Enviando código...";
            phoneStatusMessage.style.color = "blue";

            try {
                confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
                phoneStatusMessage.innerText = "Código enviado! Verifique seu SMS.";
                phoneStatusMessage.style.color = "green";
                sendCodeButton.style.display = "none";
                sendCodeSection.style.display = "none";
                verifyCodeSection.style.display = "block";
            } catch (error) {
                console.error("Erro ao enviar código:", error);
                phoneStatusMessage.innerText = "Erro ao enviar código: " + error.message;
                phoneStatusMessage.style.color = "red";
                sendCodeButton.disabled = false;
                if (recaptchaVerifier) {
                    recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                }
            }
        }

        // Handle verifying the SMS code
        async function handleVerifyCode(event) {
            event.preventDefault();

            const verificationCodeInput = document.getElementById("verificationCode");
            const phoneStatusMessage = document.getElementById("phoneStatusMessage");
            const verifyCodeButton = document.getElementById("verifyCodeButton");
            const verifyCodeSection = document.getElementById("verifyCodeSection");
            const phoneInput = document.getElementById("userPhone");

            const code = verificationCodeInput.value.trim();
            if (!code) {
                phoneStatusMessage.innerText = "Digite o código de verificação.";
                phoneStatusMessage.style.color = "red";
                return;
            }

            verifyCodeButton.disabled = true;
            phoneStatusMessage.innerText = "Verificando código...";
            phoneStatusMessage.style.color = "blue";

            try {
                const result = await confirmationResult.confirm(code);
                const user = result.user;
                console.log("Telefone verificado com sucesso!", user.phoneNumber);
                phoneStatusMessage.innerText = "Telefone verificado com sucesso!";
                phoneStatusMessage.style.color = "green";
                verifyCodeSection.style.display = "none";

                phoneInput.disabled = true;
                document.getElementById("phoneVerificationStatus").innerText =
                    "Telefone verificado: " + user.phoneNumber;
                document.getElementById("phoneVerificationStatus").style.color = "green";
                document.getElementById("recaptcha-container").style.display = "none";

                // Salva o número de telefone verificado no Firestore
                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, { phoneNumber: user.phoneNumber }, { merge: true });
                console.log("Número de telefone salvo no Firestore.");
            } catch (error) {
                console.error("Erro ao verificar código:", error);
                phoneStatusMessage.innerText = "Erro ao verificar código: " + error.message;
                phoneStatusMessage.style.color = "red";
                verifyCodeButton.disabled = false;
            }
        }

        // Handle saving name and address
        async function handleSaveProfile(event) {
            event.preventDefault();

            const user = auth.currentUser;
            if (!user) {
                alert("Você precisa estar logado para salvar o perfil.");
                return;
            }

            const name = document.getElementById("userName").value.trim();
            const address = document.getElementById("userAddress").value.trim();
            const saveButton = document.getElementById("saveProfileButton");
            const saveStatusMessage = document.getElementById("saveStatusMessage");

            saveButton.disabled = true;
            saveStatusMessage.innerText = "Salvando...";
            saveStatusMessage.style.color = "blue";

            try {
                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, {
                    name: name,
                    address: address
                }, { merge: true });
                saveStatusMessage.innerText = "Perfil salvo com sucesso!";
                saveStatusMessage.style.color = "green";
                console.log("Perfil salvo com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar perfil:", error);
                saveStatusMessage.innerText = "Erro ao salvar perfil: " + error.message;
                saveStatusMessage.style.color = "red";
            } finally {
                saveButton.disabled = false;
            }
        }

        // Function to toggle the menu popup.
        function toggleMenu() {
            const menuPopup = document.getElementById("menuPopup");
            if (menuPopup) {
                menuPopup.classList.toggle("menu-open");
            } else {
                console.error("Popup do menu não encontrado.");
            }
        }

        // Handle logout
        function handleLogout() {
            signOut(auth).then(() => {
                console.log("Usuário desconectado.");
            }).catch((error) => {
                console.error("Erro ao desconectar:", error);
                alert("Erro ao fazer logout: " + error.message);
            });
        }

        // DOMContentLoaded: Set up event listeners and initial UI state
        document.addEventListener("DOMContentLoaded", function() {
            const menuIcon = document.querySelector(".menu-icon");
            if (menuIcon) {
                menuIcon.addEventListener("click", toggleMenu);
            } else {
                console.error("Ícone do menu não encontrado.");
            }

            const closeBtn = document.querySelector(".close-menu");
            if (closeBtn) {
                closeBtn.addEventListener("click", toggleMenu);
            } else {
                console.error("Botão de fechar o menu não encontrado.");
            }

            const logoutBtn = document.getElementById("logoutButton");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", handleLogout);
            } else {
                console.error("Botão de logout não encontrado.");
            }

            document.getElementById("profileForm").addEventListener("submit", handleSaveProfile);

            document.getElementById("sendCodeForm").addEventListener("submit", handleSendCode);
            document.getElementById("verifyCodeForm").addEventListener("submit", handleVerifyCode);

            document.getElementById("verifyCodeSection").style.display = "none";
            document.getElementById("phoneStatusMessage").innerText = "";
            document.getElementById("saveStatusMessage").innerText = "";
        });
    </script>

    <style>
        :root {
            --color-primary: #0033A0; /* Azul */
            --color-secondary: #C8102E; /* Vermelho */
            --color-light: #ffffff;     /* Branco */
            --color-dark: #333;
        }

        /* Reset e estilos globais */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body {
            background: var(--color-light);
            line-height: 1.6;
            color: var(--color-dark);
        }

        .container {
            max-width: 800px;
            margin: 80px auto 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* =============================
            Cabeçalho com Ícone de Menu, Logo e Logout
            ============================= */
        header {
            background: var(--color-light);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            border-bottom: 1px solid #ddd;
            z-index: 10;
        }

        .menu-icon {
            font-size: 28px;
            color: var(--color-primary);
            cursor: pointer;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .logo {
            max-width: 120px;
            height: auto;
            display: block;
        }

        #logoutButton {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--color-secondary);
            color: var(--color-light);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
            font-weight: bold;
            transition: background 0.2s;
        }

        #logoutButton:hover {
            background-color: #a01d2d;
        }

        /* =============================
            Profile Content Styling
            ============================= */
        h2 {
            color: var(--color-primary);
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .profile-section h3 {
            color: var(--color-secondary);
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-primary);
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }

        button {
            background-color: var(--color-secondary);
            color: var(--color-light);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            background-color: #a01d2d;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #recaptcha-container {
            margin: 20px auto;
            width: 304px;
            display: none;
        }

        #phoneStatusMessage, #saveStatusMessage {
            margin-top: 10px;
            font-weight: bold;
        }

        /* =============================
            Footer
            ============================= */
        footer {
            background: var(--color-secondary);
            color: var(--color-light);
            text-align: center;
            padding: 20px 0;
            margin-top: auto;
            width: 100%;
        }

        footer p {
            font-size: 0.9em;
        }

        .whatsapp-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #25D366;
            color: var(--color-light);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            z-index: 1000;
            box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.3);
        }

        .whatsapp-float i {
            font-size: 30px;
        }

        @media (max-width: 768px) {
            .menu-icon {
                font-size: 24px;
            }
            .logo {
                max-width: 100px;
            }
            .container {
                margin-top: 70px;
                padding: 15px;
            }
            #recaptcha-container {
                width: 100%;
                display: flex;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Cabeçalho da Empresa com Logo -->
    <header>
        <img src="https://raw.githubusercontent.com/Swifthubcatalao/br/main/imagens/logo.png" alt="Logo Swift Hub Catalão">
    </header>

    <!-- Popup do Menu (removi a opção “Serviços”) -->
    <div id="menuPopup" class="menu-popup">
        <span class="close-menu">&times;</span>
        <a href="index.html">Início</a>
        <a href="perfil.html">Meu Perfil</a>
        <a href="login.html">Login</a>
    </div>

    <!-- Cabeçalho com Menu, Logo e Logout -->
    <header>
        <div class="container-header">
            <i class="fas fa-bars menu-icon"></i>
            <img src="https://raw.githubusercontent.com/Swifthubcatalao/br/main/imagens/logo.png" alt="Logo Swift Hub Catalão" class="logo">
            <button id="logoutButton">Sair</button>
        </div>
    </header>

    <!-- Conteúdo do Perfil -->
    <main class="container">
        <h2>Meu Perfil</h2>

        <div class="profile-section">
            <h3>Informações de Conta</h3>
            <div class="form-group">
                <label for="userEmail">Email:</label>
                <input type="email" id="userEmail" value="carregando..." disabled>
            </div>
        </div>

        <div class="profile-section">
            <h3>Telefone</h3>
            <p id="phoneVerificationStatus">Carregando status do telefone...</p>
            <p id="phoneStatusMessage" style="font-size: 0.9em;"></p>

            <form id="sendCodeForm">
                <div id="sendCodeSection">
                    <div class="form-group">
                        <label for="userPhone">Número de Telefone (Digite sem o código):</label>
                        <input type="tel" id="userPhone" required placeholder="Ex: 62981234567">
                    </div>
                    <div id="recaptcha-container"></div>
                    <button type="submit" id="sendCodeButton">Enviar Código</button>
                </div>
            </form>

            <form id="verifyCodeForm" style="display: none;">
                <div id="verifyCodeSection">
                    <div class="form-group">
                        <label for="verificationCode">Código de Verificação:</label>
                        <input type="text" id="verificationCode" required placeholder="Digite o código recebido por SMS">
                    </div>
                    <button type="submit" id="verifyCodeButton">Verificar Código</button>
                </div>
            </form>
        </div>

        <div class="profile-section">
            <h3>Dados Pessoais</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="userName">Nome Completo:</label>
                    <input type="text" id="userName" placeholder="Seu nome completo">
                </div>
                <div class="form-group">
                    <label for="userAddress">Endereço:</label>
                    <input type="text" id="userAddress" placeholder="Seu endereço completo">
                </div>
                <p id="saveStatusMessage" style="font-size: 0.9em;"></p>
                <button type="submit" id="saveProfileButton">Salvar Perfil</button>
            </form>
        </div>
    </main>

    <footer>
        <div class="container-footer">
            <p>&copy; 2025 Swift Hub Catalão. Todos os direitos reservados.</p>
        </div>
    </footer>

    <a href="https://wa.me/64981226078" class="whatsapp-float" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script type="module">
        // Event listeners and initialization (from the first script block) are already set up.
    </script>
</body>
</html>
